---
title: CPU和内存介绍
tags:
---



​											**CPU和内存的总体架构**



![image-20240821132032690](https://raw.githubusercontent.com/duwei0227/picbed/main/image-20240821132032690.png)





高速缓存一致性协议(cache consistency protocol)

要解决的问题

* 如何将数据从内存提取到高速缓存
* 如何将数据从高速缓存写回内存



MESI协议(其中一种)



它为高速缓存中的任何一行定义了 4 种状态，每一行（通常为 64 字节）只能处于以下状态中的一种：

* 已修改（modiﬁed），但尚未刷新到主存；
* 独占（exclusive），只出现在当前的高速缓存中，但是数据和主存一致；
* 共享（shared），可能也出现在其他高速缓存中，但是数据和主存一致；
* 无效（invalid），可能未被使用，会尽快丢弃。

该协议的理念是多个处理器可以同时处于共享状态。但是，如果一个处理器转换到其他任何一个有效状态（**独占或已修改**），那么这将强制所有其他处理器进入无效状态，如表下表所示

|      | M    | E    | S    | I    |
| ---- | ---- | ---- | ---- | ---- |
| M    | -    | -    | -    | Y    |
| E    | -    | -    | -    | Y    |
| S    | -    | -    | Y    | Y    |
| I    | Y    | Y    | Y    | Y    |

该协议是通过将某个处理器想要改变状态的意图广播出去来工作的。通过共享的内存总线发送一个电信号，其他处理器就能够意识到进而变更状态。



突发速率（burst rate），或者说理论上的最大内存带宽，基于如下几个因素：

* 内存时钟频率；
* 内存总线带宽（通常为 64 位）；
* 接口数量（现代机器通常使用两个内存接口）



CPU 时钟周期是衡量 CPU 执行速度的基本单位之一。它定义了 CPU 每次执行指令时所需的时间。时钟周期越短，CPU 的执行速度就越快。

### 1. **时钟周期的定义**

- **时钟周期（Clock Cycle）**：指的是 CPU 时钟信号的一个完整周期。它通常由两个部分组成：上升沿和下降沿。时钟信号由一个固定频率的时钟发生器产生，频率越高，时钟周期越短；类比于钟表秒针旋转一圈为一个周期。
- **时钟频率（Clock Frequency）**：指的是每秒钟发生的时钟周期的次数，通常以赫兹（Hz）为单位，现代 CPU 的频率通常以 GHz（十亿赫兹）为单位。

### 2. **时钟周期与CPU性能**

- **指令周期（Instruction Cycle）**：执行一条指令所需的时间可能会跨越多个时钟周期。不同的指令可能需要不同数量的时钟周期才能完成。
- **时钟周期时间**：时钟周期的时间可以通过时钟频率的倒数计算得出。举例来说，如果 CPU 的时钟频率是 3 GHz，那么每个时钟周期的时间为 1/3,000,000,000 秒，即大约 0.33 纳秒。
- **每周期指令数（IPC, Instructions Per Cycle）**：这个指标表示 CPU 在一个时钟周期内能够执行的指令数量。IPC 越高，意味着 CPU 在相同频率下执行指令的效率越高。





![Java线程生命周期](https://raw.githubusercontent.com/duwei0227/picbed/main/image-20240822082734551.png)



**注**：`new Thread()`只是创建了`Thread`对象，并不会对应创建线程





上下文切换

上下文切换是指操作系统调度器移除当前正在运行的线程或任务，并将其替换为等待中的
线程。

无论是用户线程之间的上下文切换，还是从用户模式进入内核模式（有时称为模式切换），
都是一个成本很高的操作。



由用户线程切换到内核模式的时候，需要强制清空指令和其他高速缓存，因
为用户空间代码所访问的内存区域与内核空间通常没有任何交叉。内核模式切换的影响会一直持续到控制权返回到用户空间之后



Linux系统通过`vDSO`（`Virtual Dynamically linked Shared Object`，虚拟动态链接共享对象）机制，优化从用户态程序到内核态的某些系统调用。它是通过映射到用户空间的一段内核代码实现的。



### **查看 vDSO**

- **检查映射**：可以使用 `cat /proc/self/maps` 或 `pmap` 命令查看当前进程的内存映射，通常可以看到一行类似于 `[vdso]` 的条目，这就是 `vDSO` 映射的地址范围。
- **检查符号**：可以使用 `readelf -s /proc/self/exe | grep vdso` 来查看程序中是否链接到了 `vDSO` 提供的函数。



### **常见 vDSO 提供的函数**

- **`gettimeofday`**：获取当前时间。
- **`clock_gettime`**：获取指定的时钟时间。
- **`time`**：获取当前时间的秒数。























